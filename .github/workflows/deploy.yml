name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Terraform Init & Apply
      working-directory: infra
      shell: pwsh
      run: |
        terraform init
        terraform apply -auto-approve
        terraform show

    - name: Get Terraform Outputs
      working-directory: infra
      shell: pwsh
      run: |
        $rg = terraform output -raw resource_group_name
        $func = terraform output -raw function_app_name
        $blob = terraform output -raw blob_account_name
        $cosmos = terraform output -raw cosmosdb_account_name

        Write-Host "Terraform Outputs:"
        Write-Host "Resource Group: $rg"
        Write-Host "Function App: $func"
        Write-Host "Blob Account: $blob"
        Write-Host "Cosmos DB: $cosmos"

        if (-not $rg -or -not $func -or -not $blob) {
          throw "Terraform outputs are empty!"
        }

        Add-Content -Path $env:GITHUB_ENV -Value "resource_group_name=$rg"
        Add-Content -Path $env:GITHUB_ENV -Value "function_app_name=$func"
        Add-Content -Path $env:GITHUB_ENV -Value "blob_account_name=$blob"
        Add-Content -Path $env:GITHUB_ENV -Value "cosmosdb_account_name=$cosmos"

    - name: Package Function App
      shell: pwsh
      run: Compress-Archive -Path function_app/* -DestinationPath functionapp.zip -Force

    - name: Deploy Function App
      shell: pwsh
      run: |
        az functionapp deployment source config-zip `
          --resource-group $env:resource_group_name `
          --name $env:function_app_name `
          --src functionapp.zip

    - name: Upload Static Files
      shell: pwsh
      run: |
        az storage blob upload-batch `
          --account-name $env:blob_account_name `
          --destination static `
          --source static `
          --overwrite