name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RANDOM_ID: c10c3c55 # Fixed random ID for predictable names
      RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
      FUNCTION_APP_NAME: crc-visitor-func-c10c3c55
      BLOB_ACCOUNT_NAME: crcstoragec10c3c55
      COSMOSDB_ACCOUNT_NAME: crccosmosc10c3c55

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set Azure SP credentials
      - name: Set Azure SP credentials
        run: |
          echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      # 4Ô∏è‚É£ Terraform Init
      - name: Terraform Init
        working-directory: infra
        run: terraform init -input=false

      # 5Ô∏è‚É£ Terraform Plan (detect changes)
      - name: Terraform Plan
        id: plan
        working-directory: infra
        run: |
          set -euo pipefail
          terraform plan -out=tfplan.out
          terraform show -json tfplan.out > tfplan.json
          changes=$(jq '.resource_changes | length' tfplan.json)
          echo "resource_changes=$changes" >> $GITHUB_ENV

      # 6Ô∏è‚É£ Terraform Apply (only if changes)
      - name: Terraform Apply
        if: env.resource_changes != '0'
        working-directory: infra
        run: terraform apply -auto-approve tfplan.out

      - name: Terraform Apply Skipped
        if: env.resource_changes == '0'
        run: echo "No infrastructure changes detected. Skipping Terraform apply."

      # 7Ô∏è‚É£ Verify resource names
      - name: Verify Resources
        run: |
          echo "Resource Group: $RESOURCE_GROUP_NAME"
          echo "Function App: $FUNCTION_APP_NAME"
          echo "Blob Account: $BLOB_ACCOUNT_NAME"
          echo "Cosmos DB: $COSMOSDB_ACCOUNT_NAME"

      # 8Ô∏è‚É£ Package Function App
      - name: Package Function App
        run: zip -r functionapp.zip function_app/*

      # 9Ô∏è‚É£ Deploy Function App
      - name: Deploy Function App
        run: |
          az functionapp deployment source config-zip \
            --resource-group $RESOURCE_GROUP_NAME \
            --name $FUNCTION_APP_NAME \
            --src functionapp.zip

      # üîü Upload Static Files to Storage Account
      - name: Upload Static Files
        run: |
          az storage blob upload-batch \
            --account-name $BLOB_ACCOUNT_NAME \
            --destination static \
            --source static \
            --overwrite
