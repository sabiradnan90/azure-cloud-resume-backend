name: Azure Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
      LOCATION: canadacentral
      FUNCTION_APP_NAME: crc-visitor-func-c10c3c55
      BLOB_ACCOUNT_NAME: crcstoragec10c3c55
      COSMOSDB_ACCOUNT_NAME: crccosmosc10c3c55

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check Resource Group
        run: |
          if az group show --name $RESOURCE_GROUP_NAME &> /dev/null; then
            echo "Resource Group exists ✅"
          else
            az group create --name $RESOURCE_GROUP_NAME --location $LOCATION
            echo "Resource Group created ✅"
          fi

      - name: Check Cosmos DB
        run: |
          if az cosmosdb show --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            echo "Cosmos DB account already exists ✅"
          else
            az cosmosdb create --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME --locations regionName=$LOCATION
            echo "Cosmos DB account created ✅"
          fi

      - name: Set Cosmos DB connection string
        run: |
          CONNECTION_STRING=$(az cosmosdb keys list \
            --name $COSMOSDB_ACCOUNT_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --type keys \
            --query "primaryMasterKey" -o tsv)
          echo "COSMOS_CONNECTION_STRING=$CONNECTION_STRING" >> $GITHUB_ENV

      - name: Deploy Function App
        run: |
          # Check if Function App exists
          if az functionapp show --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            echo "Function App already exists ✅"
          else
            az functionapp create \
              --resource-group $RESOURCE_GROUP_NAME \
              --consumption-plan-location $LOCATION \
              --runtime python \
              --functions-version 4 \
              --name $FUNCTION_APP_NAME \
              --storage-account $BLOB_ACCOUNT_NAME
            echo "Function App created ✅"
          fi

          # Set app settings
          az functionapp config appsettings set \
            --name $FUNCTION_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --settings \
              COSMOS_DB_ACCOUNT=$COSMOSDB_ACCOUNT_NAME \
              COSMOS_DB_DATABASE=VisitorDB \
              COSMOS_DB_CONTAINER=VisitorContainer

      - name: Deploy Function App code
        run: |
          cd function_app
          zip -r functionapp.zip *
          az functionapp deployment source config-zip \
            --name $FUNCTION_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --src functionapp.zip

      - name: Upload static website
        run: |
          az storage blob upload-batch \
            --account-name $BLOB_ACCOUNT_NAME \
            --destination '$web' \
            --source ./static \
            --overwrite

      - name: Fetch Visitor Counter URL
        id: visitor
        run: |
          FUNC_URL=$(az functionapp function show \
            --name $FUNCTION_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --function-name VisitorCounter \
            --query "invokeUrlTemplate" -o tsv)
          echo "Visitor Counter URL: $FUNC_URL"
          echo "VISITOR_COUNTER_URL=$FUNC_URL" >> $GITHUB_ENV

      - name: Deployment summary
        run: |
          echo "✅ Deployment Summary"
          echo "Resource Group: $RESOURCE_GROUP_NAME"
          echo "Function App: $FUNCTION_APP_NAME"
          echo "Visitor Counter URL: $VISITOR_COUNTER_URL"
          echo "Blob Account: $BLOB_ACCOUNT_NAME"
          echo "Cosmos DB: $COSMOSDB_ACCOUNT_NAME"
