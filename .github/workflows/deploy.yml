name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches:
      - main

env:
  RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
  LOCATION: canadacentral
  STORAGE_ACCOUNT_NAME: crcstoragec10c3c55
  FUNCTION_APP_NAME: crc-visitor-func-c10c3c55
  COSMOSDB_ACCOUNT_NAME: crccosmosc10c3c55
  COSMOS_DB_NAME: crcdb
  COSMOS_CONTAINER_NAME: visitorcounter

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Resource Group exists
        run: |
          if ! az group show --name $RESOURCE_GROUP_NAME &> /dev/null; then
            az group create --name $RESOURCE_GROUP_NAME --location $LOCATION
          else
            echo "Resource Group exists ✅"
          fi

      - name: Ensure Cosmos DB exists
        run: |
          if ! az cosmosdb show --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            az cosmosdb create --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME --locations regionName=$LOCATION --default-consistency-level "Session"
            az cosmosdb sql database create --account-name $COSMOSDB_ACCOUNT_NAME --name $COSMOS_DB_NAME --resource-group $RESOURCE_GROUP_NAME
            az cosmosdb sql container create --account-name $COSMOSDB_ACCOUNT_NAME --database-name $COSMOS_DB_NAME --name $COSMOS_CONTAINER_NAME --partition-key-path "/id"
          else
            echo "Cosmos DB account already exists ✅"
          fi

      - name: Get Cosmos DB Connection String
        id: cosmos-conn
        run: |
          CONNECTION_STRING=$(az cosmosdb keys list --type connection-strings --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME --query "connectionStrings[0].connectionString" -o tsv)
          echo "CONNECTION_STRING=$CONNECTION_STRING" >> $GITHUB_ENV

      - name: Create Function App if not exists
        run: |
          if ! az functionapp show --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            az functionapp create \
              --name $FUNCTION_APP_NAME \
              --storage-account $STORAGE_ACCOUNT_NAME \
              --consumption-plan-location $LOCATION \
              --resource-group $RESOURCE_GROUP_NAME \
              --runtime python \
              --runtime-version 3.11 \
              --functions-version 4
          else
            echo "Function App already exists ✅"
          fi

      - name: Configure Function App settings
        run: |
          az functionapp config appsettings set --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP_NAME --settings \
            COSMOS_CONNECTION_STRING="$CONNECTION_STRING" \
            COSMOS_DB_ACCOUNT="$COSMOSDB_ACCOUNT_NAME" \
            COSMOS_DB_DATABASE="$COSMOS_DB_NAME" \
            COSMOS_DB_CONTAINER="$COSMOS_CONTAINER_NAME"

      - name: Deploy Function App code
        run: |
          cd function_app
          zip -r ../functionapp.zip .
          cd ..
          az functionapp deployment source config-zip --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP_NAME --src functionapp.zip

      - name: Get Visitor Counter URL
        run: |
          FUNC_URL=$(az functionapp function show --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP_NAME --function-name VisitorCounter --query "invokeUrlTemplate" -o tsv)
          echo "Visitor Counter URL: $FUNC_URL"

      - name: Deployment Summary
        run: |
          echo "✅ Deployment Summary"
          echo "Resource Group: $RESOURCE_GROUP_NAME"
          echo "Function App: $FUNCTION_APP_NAME"
          echo "Visitor Counter URL: $FUNC_URL"
          echo "Blob Account: $STORAGE_ACCOUNT_NAME"
          echo "Cosmos DB: $COSMOSDB_ACCOUNT_NAME"
