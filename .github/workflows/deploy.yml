name: Deploy Azure Function App (Python)

on:
  push:
    branches:
      - main

env:
  RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
  LOCATION: "Canada Central"
  STORAGE_ACCOUNT_NAME: crcstoragec10c3c55
  FUNCTION_APP_NAME: crc-visitor-func-py
  PLAN_NAME: crc-func-plan-py
  COSMOSDB_ACCOUNT_NAME: crccosmosc10c3c55
  COSMOS_DB_NAME: azurevisitor
  COSMOS_CONTAINER_NAME: visitorcontainer

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Create resource group if it doesn't exist
      - name: Create Resource Group
        run: |
          if ! az group show --name $RESOURCE_GROUP_NAME &> /dev/null; then
            az group create --name $RESOURCE_GROUP_NAME --location "$LOCATION"
          else
            echo "Resource Group exists ✅"
          fi

      # Create storage account if it doesn't exist
      - name: Create Storage Account
        run: |
          if ! az storage account show --name $STORAGE_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            az storage account create --name $STORAGE_ACCOUNT_NAME --location "$LOCATION" --resource-group $RESOURCE_GROUP_NAME --sku Standard_LRS
          else
            echo "Storage Account exists ✅"
          fi

      # Create Cosmos DB if it doesn't exist
      - name: Create Cosmos DB Account
        run: |
          if ! az cosmosdb show --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            az cosmosdb create --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME --kind MongoDB
          else
            echo "Cosmos DB exists ✅"
          fi

      # Get Cosmos DB connection string
      - name: Get Cosmos DB Connection String
        id: cosmos
        run: |
          CONNECTION_STRING=$(az cosmosdb keys list --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME --type connection-strings --query "connectionStrings[0].connectionString" -o tsv)
          echo "CONNECTION_STRING=$CONNECTION_STRING" >> $GITHUB_ENV

      # Create Function App plan if it doesn't exist
      - name: Create Function App Plan
        run: |
          if ! az functionapp plan show --name $PLAN_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            az functionapp plan create --name $PLAN_NAME --resource-group $RESOURCE_GROUP_NAME --location "$LOCATION" --sku Y1 --is-linux
          else
            echo "Function App Plan exists ✅"
          fi

      # Create Python Function App
      - name: Create Python Function App
        run: |
          if ! az functionapp show --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            az functionapp create \
              --name $FUNCTION_APP_NAME \
              --storage-account $STORAGE_ACCOUNT_NAME \
              --plan $PLAN_NAME \
              --resource-group $RESOURCE_GROUP_NAME \
              --runtime python \
              --runtime-version 3.11 \
              --functions-version 4 \
              --os-type Linux
          else
            echo "Function App exists ✅"
          fi

      # Configure environment variables for Function App
      - name: Set Function App Settings
        run: |
          az functionapp config appsettings set \
            --name $FUNCTION_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --settings COSMOS_CONNECTION_STRING="$CONNECTION_STRING" COSMOS_DB_NAME="$COSMOS_DB_NAME" COSMOS_CONTAINER_NAME="$COSMOS_CONTAINER_NAME"

      # Deploy Function App code
      - name: Deploy Function App
        run: |
          cd function_app
          zip -r ../function_app.zip .
          cd ..
          az functionapp deployment source config-zip \
            --name $FUNCTION_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --src function_app.zip

      # Print visitor counter URL
      - name: Visitor Counter URL
        run: |
          FUNC_URL="https://$FUNCTION_APP_NAME.azurewebsites.net/api/visitorcounter"
          echo "✅ Visitor Counter URL: $FUNC_URL"