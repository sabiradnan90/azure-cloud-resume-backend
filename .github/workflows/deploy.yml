name: Deploy Azure Function

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # Match your function runtime

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r function_app/requirements.txt

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set environment variables
      run: |
        echo "RESOURCE_GROUP_NAME=azure-cloud-resume-rg-c10c3c55" >> $GITHUB_ENV
        echo "FUNCTION_APP_NAME=crc-visitor-func-c10c3c55" >> $GITHUB_ENV
        echo "COSMOS_CONNECTION_STRING=$(az cosmosdb keys list --name crccosmosc10c3c55 --resource-group $RESOURCE_GROUP_NAME --type connection-strings --query 'connectionStrings[0].connectionString' -o tsv)" >> $GITHUB_ENV
        echo "COSMOS_DB_NAME=crccosmosc10c3c55" >> $GITHUB_ENV
        echo "COSMOS_CONTAINER_NAME=visitorcounter" >> $GITHUB_ENV

    - name: Create Cosmos DB container if missing
      run: |
        az cosmosdb sql container create \
          --resource-group $RESOURCE_GROUP_NAME \
          --account-name crccosmosc10c3c55 \
          --database-name $COSMOS_DB_NAME \
          --name $COSMOS_CONTAINER_NAME \
          --partition-key-path "/id" \
          --throughput 400 || echo "Container may already exist"

    - name: Deploy Azure Function (zip deployment)
      run: |
        cd function_app
        zip -r ../function.zip . 
        cd ..
        az functionapp deployment source config-zip \
          --resource-group $RESOURCE_GROUP_NAME \
          --name $FUNCTION_APP_NAME \
          --src function.zip

    - name: Show deployed function URL
      run: |
            echo "âœ… Visitor Counter URL: https://$FUNCTION_APP_NAME.azurewebsites.net/api/visitorcounter"
