name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
      FUNCTION_APP_NAME: crc-visitor-func-c10c3c55
      BLOB_ACCOUNT_NAME: crcstoragec10c3c55
      COSMOSDB_ACCOUNT_NAME: crccosmosc10c3c55
      DATABASE_NAME: VisitorDB
      CONTAINER_NAME: Counter
      LOCATION: canadacentral

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Azure Login
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3Ô∏è‚É£ Verify Resource Group
      - name: Verify Resource Group
        run: |
          echo "Checking existing resource group..."
          az group show --name $RESOURCE_GROUP_NAME --output table

      # 4Ô∏è‚É£ Verify or Create Cosmos DB Resources
      - name: Verify or Create Cosmos DB Resources
        run: |
          echo "Checking Cosmos DB Account..."
          if ! az cosmosdb show --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME &>/dev/null; then
            echo "Creating Cosmos DB account..."
            az cosmosdb create \
              --name $COSMOSDB_ACCOUNT_NAME \
              --resource-group $RESOURCE_GROUP_NAME \
              --kind GlobalDocumentDB \
              --locations regionName=$LOCATION failoverPriority=0 isZoneRedundant=False
          else
            echo "Cosmos DB account already exists ‚úÖ"
          fi

          echo "Checking database..."
          if ! az cosmosdb sql database show --account-name $COSMOSDB_ACCOUNT_NAME \
            --resource-group $RESOURCE_GROUP_NAME --name $DATABASE_NAME &>/dev/null; then
            echo "Creating database..."
            az cosmosdb sql database create \
              --account-name $COSMOSDB_ACCOUNT_NAME \
              --resource-group $RESOURCE_GROUP_NAME \
              --name $DATABASE_NAME
          else
            echo "Database already exists ‚úÖ"
          fi

          echo "Checking container..."
          if ! az cosmosdb sql container show --account-name $COSMOSDB_ACCOUNT_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --database-name $DATABASE_NAME \
            --name $CONTAINER_NAME &>/dev/null; then
            echo "Creating container..."
            az cosmosdb sql container create \
              --account-name $COSMOSDB_ACCOUNT_NAME \
              --resource-group $RESOURCE_GROUP_NAME \
              --database-name $DATABASE_NAME \
              --name $CONTAINER_NAME \
              --partition-key-path "/id"
          else
            echo "Container already exists ‚úÖ"
          fi

      # 5Ô∏è‚É£ Retrieve Cosmos DB Connection String
      - name: Get Cosmos DB Connection String
        id: cosmos
        run: |
          CONNECTION_STRING=$(az cosmosdb keys list \
            --type connection-strings \
            --name $COSMOSDB_ACCOUNT_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --query "connectionStrings[0].connectionString" -o tsv)
          echo "COSMOS_CONNECTION_STRING=$CONNECTION_STRING" >> $GITHUB_ENV

      # 6Ô∏è‚É£ Update Function App Settings
      - name: Configure Function App with Cosmos DB Connection
        run: |
          echo "Setting Cosmos DB connection string in Function App..."
          az functionapp config appsettings set \
            --name $FUNCTION_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --settings \
              "COSMOS_CONNECTION_STRING=${{ env.COSMOS_CONNECTION_STRING }}" \
              "COSMOS_DB_NAME=$DATABASE_NAME" \
              "COSMOS_CONTAINER_NAME=$CONTAINER_NAME"

      # 7Ô∏è‚É£ Package Function App
      - name: Package Function App
        run: |
          cd function_app
          zip -r ../functionapp.zip .
          cd ..

      # 8Ô∏è‚É£ Deploy Function App
      - name: Deploy Function App
        run: |
          echo "Deploying Function App..."
          az functionapp deployment source config-zip \
            --resource-group $RESOURCE_GROUP_NAME \
            --name $FUNCTION_APP_NAME \
            --src functionapp.zip

      # 9Ô∏è‚É£ Upload Static Files to Blob Storage
      - name: Upload Static Files
        run: |
          echo "Uploading static website files..."
          az storage blob upload-batch \
            --account-name $BLOB_ACCOUNT_NAME \
            --destination '$web' \
            --source static \
            --overwrite \
            --auth-mode login

      # üîü Get Function URL (fixed command)
      - name: Get Function URL
        run: |
          echo "Fetching Function URL..."
          az rest \
            --method get \
            --url "https://management.azure.com/subscriptions/$(az account show --query id -o tsv)/resourceGroups/$RESOURCE_GROUP_NAME/providers/Microsoft.Web/sites/$FUNCTION_APP_NAME/functions?api-version=2022-03-01" \
            --query "value[].properties.invokeUrlTemplate" \
            --output tsv

      # üß© Deployment Summary
      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment Completed!"
          echo "Resource Group: $RESOURCE_GROUP_NAME"
          echo "Function App: $FUNCTION_APP_NAME"
          echo "Blob Account: $BLOB_ACCOUNT_NAME"
          echo "Cosmos DB: $COSMOSDB_ACCOUNT_NAME"
          echo ""
          echo "üéØ Visit Function App at:"
          echo "https://$FUNCTION_APP_NAME.azurewebsites.net/api/VisitorCounter"
          echo "üåê Static Website:"
          echo "https://$BLOB_ACCOUNT_NAME.z13.web.core.windows.net/"
