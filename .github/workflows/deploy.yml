name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    # 1Ô∏è‚É£ Checkout the repository
    - name: Checkout Repo
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0

    # 3Ô∏è‚É£ Login to Azure
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 4Ô∏è‚É£ Terraform Init
    - name: Terraform Init
      working-directory: infra
      run: terraform init -input=false

    # 5Ô∏è‚É£ Terraform Apply
    - name: Terraform Apply
      working-directory: infra
      run: terraform apply -auto-approve

    # 6Ô∏è‚É£ Fetch Terraform Outputs safely
    - name: Get Terraform Outputs
      working-directory: infra
      run: |
        echo "Fetching Terraform outputs..."
        terraform output -json > outputs.json
        cat outputs.json

        echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_ENV
        echo "function_app_name=$(terraform output -raw function_app_name)" >> $GITHUB_ENV
        echo "blob_account_name=$(terraform output -raw blob_account_name)" >> $GITHUB_ENV
        echo "cosmosdb_account_name=$(terraform output -raw cosmosdb_account_name)" >> $GITHUB_ENV

    # 7Ô∏è‚É£ Debug outputs (optional, recommended for first run)
    - name: Debug Terraform Outputs
      run: |
        echo "Resource Group: ${{ env.resource_group_name }}"
        echo "Function App: ${{ env.function_app_name }}"
        echo "Blob Account: ${{ env.blob_account_name }}"
        echo "Cosmos DB: ${{ env.cosmosdb_account_name }}"

    # 8Ô∏è‚É£ Package Function App
    - name: Package Function App
      shell: pwsh
      run: Compress-Archive -Path function_app/* -DestinationPath functionapp.zip -Force

    # 9Ô∏è‚É£ Deploy Function App (only if outputs exist)
    - name: Deploy Function App
      shell: pwsh
      run: |
        if (-not $env:resource_group_name -or -not $env:function_app_name) {
          Write-Error "Missing required environment variables for deployment. Exiting."
          exit 1
        }

        az functionapp deployment source config-zip `
          --resource-group $env:resource_group_name `
          --name $env:function_app_name `
          --src functionapp.zip

    # üîü Upload Static Files to Blob Storage (only if blob_account_name exists)
    - name: Upload Static Files
      shell: pwsh
      run: |
        if (-not $env:blob_account_name) {
          Write-Warning "Blob account name missing. Skipping static files upload."
        } else {
          az storage blob upload-batch `
            --account-name $env:blob_account_name `
            --destination static `
            --source static `
            --overwrite
        }