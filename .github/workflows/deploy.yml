name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Predefined resource names (replace RANDOM_ID if you want dynamic)
      RANDOM_ID: c10c3c55
      RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
      FUNCTION_APP_NAME: crc-visitor-func-c10c3c55
      BLOB_ACCOUNT_NAME: crcstoragec10c3c55
      COSMOSDB_ACCOUNT_NAME: crccosmosc10c3c55

    steps:
      # 1Ô∏è‚É£ Checkout Repo
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      # 3Ô∏è‚É£ Terraform Init
      - name: Terraform Init
        working-directory: infra
        run: terraform init -input=false

      # 4Ô∏è‚É£ Terraform Plan (detect changes)
      - name: Terraform Plan
        id: plan
        working-directory: infra
        run: |
          set -euo pipefail
          terraform plan -detailed-exitcode -out=tfplan.out || exit_code=$?
          # exit_code: 0 = no changes, 2 = changes, 1 = error
          echo "plan_exit_code=${exit_code:-0}" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Terraform Apply (only if changes)
      - name: Terraform Apply
        if: env.plan_exit_code == '2'
        working-directory: infra
        run: terraform apply -auto-approve tfplan.out

      - name: Terraform Apply Skipped
        if: env.plan_exit_code != '2'
        run: echo "No infrastructure changes detected. Skipping Terraform apply."

      # 6Ô∏è‚É£ Azure Login
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 7Ô∏è‚É£ Package Function App
      - name: Package Function App
        run: zip -r functionapp.zip function_app/*

      # 8Ô∏è‚É£ Deploy Function App
      - name: Deploy Function App
        run: |
          az functionapp deployment source config-zip \
            --resource-group $RESOURCE_GROUP_NAME \
            --name $FUNCTION_APP_NAME \
            --src functionapp.zip

      # 9Ô∏è‚É£ Upload Static Files
      - name: Upload Static Files
        run: |
          az storage blob upload-batch \
            --account-name $BLOB_ACCOUNT_NAME \
            --destination static \
            --source static \
            --overwrite

      # üîü Verify Resources
      - name: Verify Resources
        run: |
          echo "Resource Group: $RESOURCE_GROUP_NAME"
          echo "Function App: $FUNCTION_APP_NAME"
          echo "Blob Account: $BLOB_ACCOUNT_NAME"
          echo "Cosmos DB: $COSMOSDB_ACCOUNT_NAME"