name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repo
    - name: Checkout Repo
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Set Azure SP credentials for Terraform
    - name: Set Azure SP credentials
      run: |
        echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV

    # 3Ô∏è‚É£ Setup Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0

    # 4Ô∏è‚É£ Terraform Init (backend authenticated via SP)
    - name: Terraform Init
      working-directory: infra
      run: terraform init -input=false

    # 5Ô∏è‚É£ Terraform Apply
    - name: Terraform Apply
      working-directory: infra
      run: terraform apply -auto-approve

    # 6Ô∏è‚É£ List Terraform State (debug)
    - name: List Terraform State
      working-directory: infra
      run: terraform state list

    # 7Ô∏è‚É£ Fetch Terraform Outputs
    - name: Get Terraform Outputs
      working-directory: infra
      run: |
        echo "Fetching Terraform outputs..."
        terraform output -json > outputs.json
        cat outputs.json

        echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_ENV
        echo "function_app_name=$(terraform output -raw function_app_name)" >> $GITHUB_ENV
        echo "blob_account_name=$(terraform output -raw blob_account_name)" >> $GITHUB_ENV
        echo "cosmosdb_account_name=$(terraform output -raw cosmosdb_account_name)" >> $GITHUB_ENV

    # 8Ô∏è‚É£ Debug Outputs
    - name: Debug Outputs
      run: |
        echo "Resource Group: ${{ env.resource_group_name }}"
        echo "Function App: ${{ env.function_app_name }}"
        echo "Blob Account: ${{ env.blob_account_name }}"
        echo "Cosmos DB: ${{ env.cosmosdb_account_name }}"

    # 9Ô∏è‚É£ Package Function App
    - name: Package Function App
      run: zip -r functionapp.zip function_app/*

    # üîü Deploy Function App
    - name: Deploy Function App
      run: |
        if [ -z "${{ env.resource_group_name }}" ] || [ -z "${{ env.function_app_name }}" ]; then
          echo "Required environment variables are missing. Exiting."
          exit 1
        fi

        az functionapp deployment source config-zip \
          --resource-group ${{ env.resource_group_name }} \
          --name ${{ env.function_app_name }} \
          --src functionapp.zip

    # 1Ô∏è‚É£1Ô∏è‚É£ Upload Static Files to Blob Storage
    - name: Upload Static Files
      run: |
        if [ -z "${{ env.blob_account_name }}" ]; then
          echo "Blob account name missing. Skipping upload."
        else
          az storage blob upload-batch \
            --account-name ${{ env.blob_account_name }} \
            --destination static \
            --source static \
            --overwrite