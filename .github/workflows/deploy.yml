name: Deploy Visitor Counter

on:
  push:
    branches:
      - main

env:
  RESOURCE_GROUP: azure-cloud-resume-rg-c10c3c55
  STORAGE_ACCOUNT: crctoragec10c3c55
  FUNCTION_APP: crc-visitor-func-c10c3c55
  PLAN: crc-func-plan-c10c3c55
  LOCATION: "Canada Central"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Resource Group
        run: |
          az group create --name $RESOURCE_GROUP --location "$LOCATION" || echo "exists"

      - name: Ensure Storage Account
        run: |
          az storage account create --name $STORAGE_ACCOUNT --resource-group $RESOURCE_GROUP --sku Standard_LRS --location "$LOCATION" || echo "exists"

      - name: Ensure Function App Plan
        run: |
          az functionapp plan create --name $PLAN --resource-group $RESOURCE_GROUP --location "$LOCATION" --sku Y1 --is-linux || echo "exists"

      - name: Ensure Function App
        run: |
          az functionapp create \
            --name $FUNCTION_APP \
            --storage-account $STORAGE_ACCOUNT \
            --plan $PLAN \
            --resource-group $RESOURCE_GROUP \
            --runtime python \
            --runtime-version 3.11 \
            --functions-version 4 \
            --os-type Linux || echo "exists"

      - name: Configure App Settings
        run: |
          az functionapp config appsettings set \
            --name $FUNCTION_APP \
            --resource-group $RESOURCE_GROUP \
            --settings FUNCTIONS_WORKER_RUNTIME=python

      - name: Deploy Function
        run: |
          cd function_app
          zip -r ../function_app.zip .
          az functionapp deployment source config-zip --name $FUNCTION_APP --resource-group $RESOURCE_GROUP --src ../function_app.zip

      - name: Show Visitor Counter URL
        run: echo "âœ… Visitor Counter URL: https://$FUNCTION_APP.azurewebsites.net/api/visitorcounter"
