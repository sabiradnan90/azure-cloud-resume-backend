name: Deploy Python Azure Function

on:
  push:
    branches:
      - main

env:
  RESOURCE_GROUP: azure-cloud-resume-rg-c10c3c55
  FUNCTION_APP: crc-visitor-func-c10c3c55
  LOCATION: canadacentral
  STORAGE_ACCOUNT: crcvisitorstc10c3c55  # <= 24 chars, globally unique

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group if missing
      run: |
        if ! az group show --name $RESOURCE_GROUP >/dev/null 2>&1; then
          az group create --name $RESOURCE_GROUP --location $LOCATION
        fi

    - name: Create Storage Account if missing
      run: |
        if ! az storage account show --name $STORAGE_ACCOUNT --resource-group $RESOURCE_GROUP >/dev/null 2>&1; then
          az storage account create \
            --name $STORAGE_ACCOUNT \
            --resource-group $RESOURCE_GROUP \
            --location $LOCATION \
            --sku Standard_LRS
        fi

    - name: Create Function App if missing
      run: |
        if ! az functionapp show --name $FUNCTION_APP --resource-group $RESOURCE_GROUP >/dev/null 2>&1; then
          az functionapp create \
            --resource-group $RESOURCE_GROUP \
            --consumption-plan-location $LOCATION \
            --runtime python \
            --runtime-version 3.11 \
            --functions-version 4 \
            --name $FUNCTION_APP \
            --storage-account $STORAGE_ACCOUNT \
            --os-type Linux
        fi

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        cd function_app
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt --target .
        fi

    - name: Zip Function App
      run: |
        cd function_app
        zip -r ../deploy.zip .

    - name: Deploy to Azure Function App
      run: |
        az functionapp deployment source config-zip \
          --resource-group $RESOURCE_GROUP \
          --name $FUNCTION_APP \
          --src deploy.zip

    - name: Show Function App URL
      run: |
        echo "✅ Function deployed!"
        echo "✅ URL: https://${FUNCTION_APP}.azurewebsites.net/api/VisitorCounter"

    - name: Tail Function App Logs (optional)
      run: |
        az functionapp log tail \
          --name $FUNCTION_APP \
          --resource-group $RESOURCE_GROUP
