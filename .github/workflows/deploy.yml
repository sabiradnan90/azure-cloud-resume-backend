name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
      FUNCTION_APP_NAME: crc-visitor-func-c10c3c55
      BLOB_ACCOUNT_NAME: crcstoragec10c3c55
      COSMOSDB_ACCOUNT_NAME: crccosmosc10c3c55
      LOCATION: canadacentral  # matches your existing RG location

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2️⃣ Azure Login (using your secret)
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ⚙️ Skip creating resource group (it already exists)
      - name: Verify Resource Group
        run: |
          echo "Checking if resource group exists..."
          az group show --name $RESOURCE_GROUP_NAME --output table

      # 3️⃣ Package Function App
      - name: Package Function App
        run: zip -r functionapp.zip function_app/*

      # 4️⃣ Deploy Function App
      - name: Deploy Function App
        run: |
          az functionapp deployment source config-zip \
            --resource-group $RESOURCE_GROUP_NAME \
            --name $FUNCTION_APP_NAME \
            --src functionapp.zip

      # 5️⃣ Upload Static Files to Blob Storage
      - name: Upload Static Files
        run: |
          az storage blob upload-batch \
            --account-name $BLOB_ACCOUNT_NAME \
            --destination static \
            --source static \
            --overwrite

      # 6️⃣ Verify Deployment
      - name: Verify Resources
        run: |
          echo "✅ Deployment Summary"
          echo "Resource Group: $RESOURCE_GROUP_NAME"
          echo "Function App: $FUNCTION_APP_NAME"
          echo "Blob Account: $BLOB_ACCOUNT_NAME"
          echo "Cosmos DB: $COSMOSDB_ACCOUNT_NAME"