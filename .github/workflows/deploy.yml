name: Deploy Azure Cloud Resume Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
      FUNCTION_APP_NAME: crc-visitor-func-c10c3c55
      BLOB_ACCOUNT_NAME: crcstoragec10c3c55
      COSMOSDB_ACCOUNT_NAME: crccosmosc10c3c55
      LOCATION: canadacentral

    steps:
      # 1ï¸âƒ£ Checkout Repo
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Azure Login
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3ï¸âƒ£ Verify Resource Group (skip creation if exists)
      - name: Verify Resource Group
        run: |
          if az group show --name $RESOURCE_GROUP_NAME &> /dev/null; then
            echo "Resource Group exists âœ…"
          else
            echo "Resource Group not found. Creating..."
            az group create --name $RESOURCE_GROUP_NAME --location $LOCATION
          fi

      # 4ï¸âƒ£ Verify Cosmos DB Account, Database, and Container
      - name: Setup Cosmos DB
        run: |
          if az cosmosdb show --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            echo "Cosmos DB account already exists âœ…"
          else
            az cosmosdb create --name $COSMOSDB_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME --locations regionName=$LOCATION --kind GlobalDocumentDB
          fi

          # Database
          if az cosmosdb sql database show --account-name $COSMOSDB_ACCOUNT_NAME --name VisitorDB --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            echo "Database already exists âœ…"
          else
            az cosmosdb sql database create --account-name $COSMOSDB_ACCOUNT_NAME --name VisitorDB --resource-group $RESOURCE_GROUP_NAME
          fi

          # Container
          if az cosmosdb sql container show --account-name $COSMOSDB_ACCOUNT_NAME --database-name VisitorDB --name Counter --resource-group $RESOURCE_GROUP_NAME &> /dev/null; then
            echo "Container already exists âœ…"
          else
            az cosmosdb sql container create \
              --account-name $COSMOSDB_ACCOUNT_NAME \
              --database-name VisitorDB \
              --name Counter \
              --partition-key-path /id \
              --resource-group $RESOURCE_GROUP_NAME
          fi

      # 5ï¸âƒ£ Fetch Cosmos DB connection string and set in Function App
      - name: Set Cosmos DB Connection in Function App
        run: |
          CONNECTION_STRING=$(az cosmosdb keys list \
            --name $COSMOSDB_ACCOUNT_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --type connection-strings \
            --query "connectionStrings[0].connectionString" -o tsv)
          az functionapp config appsettings set \
            --name $FUNCTION_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --settings COSMOS_CONNECTION_STRING="$CONNECTION_STRING" \
                       COSMOS_DB_NAME="VisitorDB" \
                       COSMOS_CONTAINER_NAME="Counter"

      # 6ï¸âƒ£ Package Function App
      - name: Package Function App
        run: zip -r functionapp.zip function_app/*

      # 7ï¸âƒ£ Deploy Function App
      - name: Deploy Function App
        run: |
          az functionapp deployment source config-zip \
            --resource-group $RESOURCE_GROUP_NAME \
            --name $FUNCTION_APP_NAME \
            --src functionapp.zip

      # 8ï¸âƒ£ Upload Static Files to Blob Storage
      - name: Upload Static Files
        run: |
          az storage blob upload-batch \
            --account-name $BLOB_ACCOUNT_NAME \
            --source static \
            --destination '$web' \
            --overwrite \
            --auth-mode login

      # 9ï¸âƒ£ Fetch Function App URL
      - name: Fetch Function App URL
        run: |
          FUNC_URL=$(az functionapp show \
            --name $FUNCTION_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --query "defaultHostName" -o tsv)
          echo "Function App URL: https://$FUNC_URL"
          echo "FUNCTION_APP_URL=https://$FUNC_URL" >> $GITHUB_ENV

      # ðŸ”Ÿ Verify Deployment
      - name: Verify Deployment
        run: |
          echo "âœ… Deployment Summary"
          echo "Resource Group: $RESOURCE_GROUP_NAME"
          echo "Function App: $FUNCTION_APP_NAME"
          echo "Function App URL: $FUNCTION_APP_URL"
          echo "Blob Account: $BLOB_ACCOUNT_NAME"
          echo "Cosmos DB: $COSMOSDB_ACCOUNT_NAME"
