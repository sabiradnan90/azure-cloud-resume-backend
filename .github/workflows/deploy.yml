name: Deploy Azure Cloud Resume Backend (No Terraform)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      LOCATION: eastus
      RANDOM_ID: c10c3c55
      RESOURCE_GROUP_NAME: azure-cloud-resume-rg-c10c3c55
      STORAGE_ACCOUNT_NAME: crcstoragec10c3c55
      FUNCTION_APP_NAME: crc-visitor-func-c10c3c55
      COSMOS_ACCOUNT_NAME: crccosmosc10c3c55

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Azure Login using GitHub Secret
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3Ô∏è‚É£ Create Resource Group (if not exists)
      - name: Create Resource Group
        run: |
          echo "Creating resource group if not exists..."
          az group create \
            --name $RESOURCE_GROUP_NAME \
            --location $LOCATION

      # 4Ô∏è‚É£ Create Storage Account (if not exists)
      - name: Create Storage Account
        run: |
          echo "Ensuring storage account exists..."
          az storage account show --name $STORAGE_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME || \
          az storage account create \
            --name $STORAGE_ACCOUNT_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --location $LOCATION \
            --sku Standard_LRS

      # 5Ô∏è‚É£ Create Function App (if not exists)
      - name: Create Function App
        run: |
          echo "Ensuring Function App exists..."
          az functionapp show --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP_NAME || \
          az functionapp create \
            --resource-group $RESOURCE_GROUP_NAME \
            --consumption-plan-location $LOCATION \
            --runtime node \
            --runtime-version 18 \
            --functions-version 4 \
            --name $FUNCTION_APP_NAME \
            --storage-account $STORAGE_ACCOUNT_NAME

      # 6Ô∏è‚É£ Create Cosmos DB Account (if not exists)
      - name: Create Cosmos DB Account
        run: |
          echo "Ensuring Cosmos DB exists..."
          az cosmosdb show --name $COSMOS_ACCOUNT_NAME --resource-group $RESOURCE_GROUP_NAME || \
          az cosmosdb create \
            --name $COSMOS_ACCOUNT_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --kind GlobalDocumentDB

      # 7Ô∏è‚É£ Package Function App code
      - name: Package Function App
        run: |
          echo "Packaging function app..."
          zip -r functionapp.zip function_app/*

      # 8Ô∏è‚É£ Deploy Function App
      - name: Deploy Function App
        run: |
          echo "Deploying function app..."
          az functionapp deployment source config-zip \
            --resource-group $RESOURCE_GROUP_NAME \
            --name $FUNCTION_APP_NAME \
            --src functionapp.zip

      # 9Ô∏è‚É£ Upload Static Files to Blob Storage
      - name: Upload Static Files
        run: |
          echo "Uploading static files to storage..."
          az storage blob upload-batch \
            --account-name $STORAGE_ACCOUNT_NAME \
            --destination static \
            --source static \
            --overwrite

      # üîü Verify Deployment
      - name: Verify Resources
        run: |
          echo "‚úÖ Deployed Resources:"
          echo "Resource Group: $RESOURCE_GROUP_NAME"
          echo "Storage Account: $STORAGE_ACCOUNT_NAME"
          echo "Function App: $FUNCTION_APP_NAME"
          echo "Cosmos DB: $COSMOS_ACCOUNT_NAME"
